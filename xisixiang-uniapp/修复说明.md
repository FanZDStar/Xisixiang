# 🔧 网络请求问题修复

## 问题原因

1. **端口不匹配**：后端运行在 `127.0.0.1:5122`，但代码配置的是 `localhost:5000`
2. **静态文件服务未配置**：Markdown 文档无法加载

## 已修复内容

### 1. ✅ 修改前端 API 地址

**文件**：`src/pages/utils/request.js`

```javascript
// 修改前
const BASE_URL = "http://localhost:5000";

// 修改后
const BASE_URL = "http://127.0.0.1:5122";
```

### 2. ✅ 修改文档加载地址

**文件**：`src/pages/theory/document.vue`

```javascript
// 修改前
const baseUrl = "http://localhost:5000/static/theory/";

// 修改后
const baseUrl = "http://127.0.0.1:5122/static/theory/";
```

### 3. ✅ 配置后端静态文件服务

**文件**：`server/app.py`

添加了新的路由：

```python
@app.route('/static/theory/<path:filename>', methods=['GET'])
def serve_theory_file(filename):
    """提供 Markdown 文档静态文件服务"""
    theory_dir = os.path.join(os.path.dirname(__file__), '..', 'frontend', 'public', 'theory')
    theory_dir = os.path.abspath(theory_dir)
    return send_from_directory(theory_dir, filename, mimetype='text/markdown; charset=utf-8')
```

---

## 🚀 重启服务

### 步骤 1：重启后端服务

在后端终端（python terminal）中：

```powershell
# 按 Ctrl+C 停止当前服务

# 重新启动
python app.py
```

**确认信息**：

```
* Running on http://127.0.0.1:5122
```

### 步骤 2：重新编译小程序

在另一个终端中：

```powershell
cd d:\project\Xisixiang\xisixiang-uniapp

# 如果之前的编译还在运行，先按 Ctrl+C 停止

# 重新编译
npm run dev:mp-weixin
```

### 步骤 3：刷新微信开发者工具

在微信开发者工具中：

1. 点击「编译」按钮（或按 Ctrl+B）
2. 或者关闭项目重新导入

---

## ✅ 测试功能

### 测试 1：习题训练

1. 点击「习题训练」Tab
2. 应该能看到题目加载
3. 不再显示"加载失败"

**API 测试**：访问 http://127.0.0.1:5122/api/quiz

### 测试 2：智能问答

1. 点击「智能问答」Tab
2. 输入问题
3. 应该能收到 AI 回复

**API 测试**：

```powershell
curl -X POST http://127.0.0.1:5122/api/chat -H "Content-Type: application/json" -d "{\"messages\":[{\"role\":\"user\",\"content\":\"你好\"}]}"
```

### 测试 3：理论学习文档

1. 点击「理论学习」Tab
2. 点击任意文档
3. 应该能加载 Markdown 内容

**API 测试**：访问 http://127.0.0.1:5122/static/theory/构建全国统一大市场.md

---

## 🔍 故障排查

### 问题 1：仍然显示 ERR_CONNECTION_REFUSED

**检查**：

1. 后端是否重启成功？
2. 小程序是否重新编译？
3. 微信开发者工具是否刷新？

**解决**：

```powershell
# 完全停止后端
Ctrl+C

# 完全停止前端编译
Ctrl+C

# 重新启动后端
cd d:\project\Xisixiang\server
python app.py

# 重新启动前端编译
cd d:\project\Xisixiang\xisixiang-uniapp
npm run dev:mp-weixin
```

### 问题 2：文档仍然无法加载

**检查后端日志**：
应该看到类似这样的输出：

```
[静态文件] 请求文件: 构建全国统一大市场.md
[静态文件] 目录: D:\project\Xisixiang\frontend\public\theory
```

**检查文件路径**：
确认文件存在于：`d:\project\Xisixiang\frontend\public\theory\*.md`

### 问题 3：端口被占用

**错误信息**：`Address already in use`

**解决**：

1. 找到占用端口的进程：

```powershell
netstat -ano | findstr :5122
```

2. 结束进程：

```powershell
taskkill /PID <进程ID> /F
```

3. 或者修改端口：
   在 `server/app.py` 最后一行改成其他端口（如 5123），并同步修改前端配置。

---

## 📊 预期结果

修复后应该看到：

### 后端控制台

```
* Running on http://127.0.0.1:5122
127.0.0.1 - - [17/Oct/2025 15:00:00] "GET /api/quiz HTTP/1.1" 200 -
127.0.0.1 - - [17/Oct/2025 15:00:01] "GET /static/theory/构建全国统一大市场.md HTTP/1.1" 200 -
```

### 微信开发者工具控制台

- ✅ 没有 `ERR_CONNECTION_REFUSED` 错误
- ✅ 看到 `GET http://127.0.0.1:5122/api/quiz 200`
- ✅ 题目正常显示

### 小程序界面

- ✅ 习题训练：显示 10 道题目
- ✅ 智能问答：能正常对话
- ✅ 理论学习：能加载文档内容

---

## 💡 提示

如果一切正常，你应该能：

1. ✅ 在习题训练中答题
2. ✅ 在智能问答中和 AI 对话
3. ✅ 在理论学习中阅读文档
4. ✅ 所有功能不再报网络错误

---

**修复完成时间**：2025 年 10 月 17 日 15:00  
**需要重启**：后端 + 前端编译 + 微信开发者工具
