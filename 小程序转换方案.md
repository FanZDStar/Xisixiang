# 将 Vue 3 Web 项目转换为小程序的完整方案

## 📋 方案概览

将"构建全国统一大市场"习思想课程作业项目转换为小程序，推荐使用 **uni-app** 框架。

---

## 🎯 技术选型

### 推荐方案：uni-app（⭐⭐⭐⭐⭐）

**优势**：

- ✅ 使用 Vue 3 语法，现有代码可复用 70-80%
- ✅ 一次开发，多端部署（微信/支付宝/百度/字节跳动小程序）
- ✅ 完善的生态和文档
- ✅ 支持 NPM 包，可使用 marked 等库
- ✅ 官方提供 UI 组件库（uni-ui）

**技术栈**：

```
Vue 3 + uni-app + uniCloud（可选）
```

### 其他方案对比

| 方案               | 优势               | 劣势                     | 推荐度     |
| ------------------ | ------------------ | ------------------------ | ---------- |
| **uni-app**        | Vue 语法，跨平台   | 需要学习小程序 API       | ⭐⭐⭐⭐⭐ |
| **原生微信小程序** | 性能最优，官方支持 | 需要完全重写，无法跨平台 | ⭐⭐⭐     |
| **Taro**           | React/Vue 都支持   | 生态相对小               | ⭐⭐⭐⭐   |
| **mpvue**          | Vue 2 语法         | 已停止维护               | ❌         |

---

## 🔧 转换步骤

### 第一阶段：环境搭建

#### 1. 安装 HBuilderX（推荐）或使用 CLI

**方式 A：HBuilderX（图形化，推荐新手）**

```
1. 下载 HBuilderX: https://www.dcloud.io/hbuilderx.html
2. 安装微信开发者工具
3. 在 HBuilderX 中创建 uni-app 项目
```

**方式 B：Vue CLI（命令行，推荐有经验者）**

```powershell
# 安装 Vue CLI
npm install -g @vue/cli

# 创建 uni-app 项目
vue create -p dcloudio/uni-preset-vue miniprogram-xisixiang

# 选择 Vue 3 版本
```

#### 2. 项目结构

uni-app 项目结构：

```
miniprogram-xisixiang/
├── pages/                  # 页面目录
│   ├── index/              # 首页
│   ├── chat/               # 智能问答
│   ├── quiz/               # 习题训练
│   ├── theory/             # 理论学习
│   └── knowledge-graph/    # 知识图谱
├── components/             # 组件目录
├── static/                 # 静态资源
├── utils/                  # 工具函数
├── api/                    # API 接口
├── pages.json              # 页面配置（路由）
├── manifest.json           # 应用配置
├── App.vue                 # 应用配置
└── main.js                 # 入口文件
```

---

### 第二阶段：核心改造

#### 1. 路由系统改造

**原 Vue Router 配置**：

```javascript
// 现有的 router/index.js
const routes = [
  { path: "/chat", component: ChatView },
  { path: "/quiz", component: QuizView },
  // ...
];
```

**uni-app pages.json**：

```json
{
  "pages": [
    {
      "path": "pages/index/index",
      "style": {
        "navigationBarTitleText": "首页"
      }
    },
    {
      "path": "pages/chat/chat",
      "style": {
        "navigationBarTitleText": "智能问答",
        "navigationBarBackgroundColor": "#ff4d4d",
        "navigationBarTextStyle": "white"
      }
    },
    {
      "path": "pages/quiz/quiz",
      "style": {
        "navigationBarTitleText": "习题训练",
        "navigationBarBackgroundColor": "#ff4d4d",
        "navigationBarTextStyle": "white"
      }
    },
    {
      "path": "pages/theory/theory",
      "style": {
        "navigationBarTitleText": "理论学习",
        "navigationBarBackgroundColor": "#ff4d4d",
        "navigationBarTextStyle": "white"
      }
    },
    {
      "path": "pages/knowledge-graph/knowledge-graph",
      "style": {
        "navigationBarTitleText": "知识图谱",
        "navigationBarBackgroundColor": "#ff4d4d",
        "navigationBarTextStyle": "white"
      }
    }
  ],
  "globalStyle": {
    "navigationBarTextStyle": "white",
    "navigationBarTitleText": "习思想课程",
    "navigationBarBackgroundColor": "#ff4d4d",
    "backgroundColor": "#f5f5f5"
  },
  "tabBar": {
    "color": "#666666",
    "selectedColor": "#ff4d4d",
    "backgroundColor": "#ffffff",
    "borderStyle": "black",
    "list": [
      {
        "pagePath": "pages/chat/chat",
        "text": "智能问答",
        "iconPath": "static/tabbar/chat.png",
        "selectedIconPath": "static/tabbar/chat-active.png"
      },
      {
        "pagePath": "pages/quiz/quiz",
        "text": "习题训练",
        "iconPath": "static/tabbar/quiz.png",
        "selectedIconPath": "static/tabbar/quiz-active.png"
      },
      {
        "pagePath": "pages/theory/theory",
        "text": "理论学习",
        "iconPath": "static/tabbar/theory.png",
        "selectedIconPath": "static/tabbar/theory-active.png"
      }
    ]
  }
}
```

**导航跳转改造**：

```javascript
// 原来的 Vue Router
this.$router.push("/chat");

// 改为 uni-app
uni.navigateTo({
  url: "/pages/chat/chat",
});

// 或使用 Tab 切换
uni.switchTab({
  url: "/pages/chat/chat",
});
```

---

#### 2. API 请求改造

**原有的 API 客户端**：

```javascript
// src/api/client.js (基于 fetch)
const response = await fetch(url, options);
```

**uni-app 版本**：

```javascript
// utils/request.js
const baseURL = "http://localhost:5000"; // 或配置为云函数

export function request(options) {
  return new Promise((resolve, reject) => {
    uni.request({
      url: baseURL + options.url,
      method: options.method || "GET",
      data: options.data,
      header: {
        "Content-Type": "application/json",
        ...options.header,
      },
      success: (res) => {
        if (res.statusCode === 200) {
          resolve(res.data);
        } else {
          reject(res);
        }
      },
      fail: (err) => {
        reject(err);
      },
    });
  });
}

// 使用示例
import { request } from "@/utils/request";

// 获取题目
export function getQuestions() {
  return request({
    url: "/api/questions",
    method: "GET",
  });
}

// 智能问答
export function chatCompletion(messages) {
  return request({
    url: "/api/chat",
    method: "POST",
    data: { messages },
  });
}
```

---

#### 3. 组件改造

**智能问答组件改造示例**：

```vue
<!-- pages/chat/chat.vue -->
<template>
  <view class="chat-container">
    <!-- 快捷问题 -->
    <view v-if="messages.length === 1" class="quick-questions">
      <text class="quick-title">💡 您可能想问：</text>
      <view class="question-chips">
        <button
          v-for="(question, index) in quickQuestions"
          :key="index"
          @click="handleQuickQuestion(question)"
          :disabled="loading"
          class="chip-button"
        >
          {{ question }}
        </button>
      </view>
    </view>

    <!-- 聊天窗口 -->
    <scroll-view
      scroll-y
      class="chat-window"
      :scroll-into-view="scrollIntoView"
      :scroll-with-animation="true"
    >
      <view
        v-for="(message, index) in messages"
        :key="index"
        :class="['message', message.sender]"
        :id="'msg-' + index"
      >
        <!-- 用户消息 -->
        <view v-if="message.sender === 'user'" class="user-text">
          {{ message.text }}
        </view>
        <!-- AI 消息 - 使用 rich-text -->
        <rich-text v-else :nodes="renderMarkdown(message.text)" />
      </view>
    </scroll-view>

    <!-- 加载状态 -->
    <view v-if="loading" class="loading-banner">
      <view class="loading-dots">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
      <text>AI 正在思考中...</text>
    </view>

    <!-- 输入框 -->
    <view class="input-container">
      <textarea
        v-model="inputText"
        placeholder="💭 请输入您想了解的问题..."
        :disabled="loading"
        class="input-field"
        :auto-height="true"
        :maxlength="500"
      />
      <button
        @click="sendMessage"
        :disabled="loading || !inputText.trim()"
        class="send-button"
      >
        发送
      </button>
    </view>
  </view>
</template>

<script setup>
import { ref, nextTick } from "vue";
import { chatCompletion } from "@/api/chat";
import { markdownToHtml } from "@/utils/markdown";

const messages = ref([
  {
    sender: "bot",
    text: "👋 **您好！我是全国统一大市场政策智能助手。**\n\n我可以帮您解答各类问题...",
  },
]);

const inputText = ref("");
const loading = ref(false);
const scrollIntoView = ref("");

const quickQuestions = ref([
  "什么是全国统一大市场？",
  "为什么要构建全国统一大市场？",
  "统一大市场建设的主要内容是什么？",
  "如何纵深推进统一大市场建设？",
]);

// Markdown 渲染（简化版）
const renderMarkdown = (text) => {
  return markdownToHtml(text);
};

// 发送消息
const sendMessage = async () => {
  if (!inputText.value.trim() || loading.value) return;

  const userMessage = inputText.value.trim();
  messages.value.push({ sender: "user", text: userMessage });
  inputText.value = "";
  loading.value = true;

  // 滚动到底部
  nextTick(() => {
    scrollIntoView.value = "msg-" + (messages.value.length - 1);
  });

  try {
    const response = await chatCompletion(buildPayload());
    messages.value.push({
      sender: "bot",
      text: response.reply || "抱歉，我暂时无法回答这个问题。",
    });
  } catch (error) {
    messages.value.push({
      sender: "bot",
      text: "⚠️ 服务暂时不可用，请稍后再试。",
    });
    uni.showToast({
      title: "网络错误",
      icon: "none",
    });
  } finally {
    loading.value = false;
    nextTick(() => {
      scrollIntoView.value = "msg-" + (messages.value.length - 1);
    });
  }
};

// 构建对话历史
const buildPayload = () => {
  return messages.value
    .filter((m) => m.sender === "user" || m.sender === "bot")
    .map((m) => ({
      role: m.sender === "bot" ? "assistant" : "user",
      content: m.text,
    }));
};

// 快捷问题
const handleQuickQuestion = (question) => {
  inputText.value = question;
  sendMessage();
};
</script>

<style scoped>
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background-color: #f5f5f5;
}

.chat-window {
  flex: 1;
  padding: 20rpx;
}

.message {
  max-width: 80%;
  padding: 20rpx;
  margin-bottom: 20rpx;
  border-radius: 10rpx;
  word-wrap: break-word;
}

.message.user {
  align-self: flex-end;
  background: linear-gradient(135deg, #ff7061, #f44336);
  color: white;
  margin-left: auto;
}

.message.bot {
  align-self: flex-start;
  background-color: white;
  border: 1px solid rgba(244, 67, 54, 0.15);
}

.input-container {
  display: flex;
  padding: 20rpx;
  background-color: white;
  border-top: 1px solid #eee;
}

.input-field {
  flex: 1;
  padding: 20rpx;
  border: 1px solid #ddd;
  border-radius: 10rpx;
  margin-right: 20rpx;
  min-height: 80rpx;
  max-height: 200rpx;
}

.send-button {
  padding: 20rpx 40rpx;
  background: linear-gradient(135deg, #ff7061, #f44336);
  color: white;
  border: none;
  border-radius: 10rpx;
  font-weight: 600;
}

.send-button[disabled] {
  opacity: 0.5;
}

.loading-banner {
  display: flex;
  align-items: center;
  padding: 20rpx;
  background-color: #fff3e0;
  margin: 20rpx;
  border-radius: 10rpx;
}

.loading-dots {
  display: flex;
  gap: 10rpx;
  margin-right: 20rpx;
}

.dot {
  width: 12rpx;
  height: 12rpx;
  border-radius: 50%;
  background-color: #ff6f00;
  animation: bounce 1.4s infinite ease-in-out both;
}

@keyframes bounce {
  0%,
  80%,
  100% {
    transform: scale(0);
  }
  40% {
    transform: scale(1);
  }
}
</style>
```

---

#### 4. Markdown 渲染改造

**Web 版使用 marked + v-html**：

```vue
<div v-html="marked.parse(content)"></div>
```

**小程序版使用 rich-text 组件**：

```vue
<rich-text :nodes="htmlString"></rich-text>
```

**注意**：小程序不支持完整的 HTML，需要简化 Markdown 渲染：

```javascript
// utils/markdown.js
// 简化版 Markdown 转换
export function markdownToHtml(markdown) {
  let html = markdown;

  // 加粗 **text** -> <strong>text</strong>
  html = html.replace(
    /\*\*(.*?)\*\*/g,
    '<strong style="color:#d32f2f">$1</strong>'
  );

  // 段落
  html = html.replace(/\n\n/g, "<br/><br/>");
  html = html.replace(/\n/g, "<br/>");

  // 列表 • item -> <li>item</li>
  html = html.replace(/^[•·]\s+(.+)$/gm, "<li>$1</li>");

  // emoji 保持原样

  return html;
}

// 或使用第三方库（推荐）
// npm install towxml
import towxml from "towxml";
```

**推荐使用 towxml 库**（更完整的 Markdown 支持）：

```javascript
// main.js
import towxml from "towxml";
const app = createSSRApp(App);
app.config.globalProperties.$towxml = towxml;

// 页面中使用
const result = this.$towxml(markdown, "markdown");
```

---

#### 5. 样式适配

**单位转换**：

```css
/* Web 版 */
.title {
  font-size: 16px;
  padding: 10px;
}

/* 小程序版 - 使用 rpx（响应式像素）*/
.title {
  font-size: 32rpx; /* 1rpx = 0.5px (在 375px 宽度设备上) */
  padding: 20rpx;
}
```

**全局样式**：

```css
/* App.vue 或 uni.scss */
page {
  background-color: #f5f5f5;
  height: 100%;
}

/* 红色主题 */
:root {
  --primary-color: #ff4d4d;
  --primary-dark: #cc0000;
  --bg-light: #fff5f5;
}
```

---

### 第三阶段：功能迁移清单

#### ✅ 可以直接迁移

- [x] 智能问答逻辑
- [x] 习题训练逻辑
- [x] API 请求（改用 uni.request）
- [x] 数据状态管理
- [x] 大部分 Vue 组件

#### ⚠️ 需要改造

- [ ] 路由系统（改用 pages.json）
- [ ] Markdown 渲染（改用 rich-text 或 towxml）
- [ ] 文件上传/下载
- [ ] 样式单位（px → rpx）
- [ ] 导航栏（使用原生）

#### ❌ 小程序不支持

- ❌ `window` 对象
- ❌ `document` 对象
- ❌ 完整的 HTML/CSS
- ❌ eval() 函数
- ❌ 部分 NPM 包（如 dompurify）

---

### 第四阶段：后端适配

#### 跨域问题

小程序需要配置合法域名：

```json
// manifest.json
{
  "mp-weixin": {
    "setting": {
      "urlCheck": false // 开发时可关闭，生产必须配置合法域名
    }
  }
}
```

**生产环境**：

1. 在微信小程序后台配置服务器域名
2. 域名必须是 HTTPS
3. 需要备案

#### API 改造建议

**方案 A：使用现有后端（需要 HTTPS）**

```javascript
const baseURL = "https://your-domain.com/api";
```

**方案 B：使用云函数（推荐）**

```javascript
// 使用 uniCloud 云函数
uniCloud.callFunction({
  name: "chatCompletion",
  data: { messages },
});
```

---

## 📦 依赖包处理

### 需要替换的包

| Web 包       | 小程序替代方案               |
| ------------ | ---------------------------- |
| `marked`     | `towxml` 或简化版自己实现    |
| `dompurify`  | 不需要（rich-text 自动过滤） |
| `vue-router` | uni-app 路由系统             |

### 安装小程序专用包

```powershell
npm install towxml  # Markdown 渲染
npm install @dcloudio/uni-ui  # UI 组件库
```

---

## 🎨 UI 组件库推荐

### uni-ui（官方）

```vue
<uni-list>
  <uni-list-item title="智能问答" />
</uni-list>
```

### uView UI（第三方，功能丰富）

```powershell
npm install uview-ui
```

---

## 🚀 开发流程

### 1. 本地开发

```powershell
npm run dev:mp-weixin  # 微信小程序
npm run dev:mp-alipay  # 支付宝小程序
```

### 2. 预览调试

- 使用微信开发者工具打开 `dist/dev/mp-weixin` 目录
- 扫码真机预览

### 3. 发布上线

```powershell
npm run build:mp-weixin  # 生产构建
```

- 上传到微信小程序后台
- 提交审核

---

## 📝 完整项目结构示例

```
miniprogram-xisixiang/
├── pages/
│   ├── index/
│   │   └── index.vue           # 首页（可选）
│   ├── chat/
│   │   └── chat.vue             # 智能问答
│   ├── quiz/
│   │   └── quiz.vue             # 习题训练
│   ├── theory/
│   │   └── theory.vue           # 理论学习
│   └── knowledge-graph/
│       └── knowledge-graph.vue  # 知识图谱
├── components/
│   ├── ChatWindow.vue           # 聊天窗口组件
│   ├── MessageInput.vue         # 消息输入组件
│   ├── QuizQuestion.vue         # 题目组件
│   └── MarkdownViewer.vue       # Markdown 查看器
├── api/
│   ├── request.js               # 请求封装
│   ├── chat.js                  # 智能问答 API
│   └── quiz.js                  # 习题 API
├── utils/
│   ├── markdown.js              # Markdown 工具
│   └── storage.js               # 本地存储
├── static/
│   ├── tabbar/                  # Tab 图标
│   └── images/                  # 图片资源
├── pages.json                   # 页面配置
├── manifest.json                # 应用配置
├── App.vue                      # 应用入口
├── main.js                      # 入口文件
├── uni.scss                     # 全局样式变量
└── package.json
```

---

## ⚠️ 注意事项

### 1. 小程序限制

- 单个小程序包大小不超过 2MB（分包可达 20MB）
- 同时打开的页面栈不超过 10 层
- 网络请求需要配置合法域名

### 2. 性能优化

- 使用分包加载
- 图片使用云存储
- 合理使用缓存
- 避免过度渲染

### 3. 审核要求

- 必须有明确的服务类目
- 内容合规
- 需要提供测试账号

---

## 🔗 参考资源

- [uni-app 官方文档](https://uniapp.dcloud.net.cn/)
- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [towxml - Markdown 渲染](https://github.com/sbfkcel/towxml)
- [uView UI](https://www.uviewui.com/)

---

## 📊 工作量评估

| 任务          | 预计时间    | 难度   |
| ------------- | ----------- | ------ |
| 环境搭建      | 0.5 天      | ⭐     |
| 路由改造      | 0.5 天      | ⭐⭐   |
| API 改造      | 1 天        | ⭐⭐   |
| 组件迁移      | 2-3 天      | ⭐⭐⭐ |
| Markdown 渲染 | 1 天        | ⭐⭐⭐ |
| 样式适配      | 1-2 天      | ⭐⭐   |
| 测试调试      | 1-2 天      | ⭐⭐   |
| **总计**      | **7-10 天** | -      |

---

**转换方案完成时间**：2025 年 10 月 17 日  
**推荐框架**：uni-app + Vue 3  
**预计工作量**：1-2 周  
**复用率**：70-80%
