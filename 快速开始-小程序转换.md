# 🚀 快速开始：将项目转换为小程序

## 方案选择建议

基于你的项目，我强烈推荐使用 **uni-app**：

✅ **优势**：

- 使用 Vue 3 语法，现有代码可复用 70-80%
- 支持同时发布到微信、支付宝、百度、字节跳动等小程序
- 成熟的生态和完善的文档

---

## 第一步：创建 uni-app 项目

### 方式 1：使用 HBuilderX（推荐新手）

1. **下载安装 HBuilderX**

   - 官网：https://www.dcloud.io/hbuilderx.html
   - 下载标准版即可

2. **创建项目**

   ```
   文件 → 新建 → 项目
   → 选择 uni-app
   → 选择 Vue3 模板
   → 输入项目名：miniprogram-xisixiang
   ```

3. **运行到微信开发者工具**
   ```
   运行 → 运行到小程序模拟器 → 微信开发者工具
   ```

### 方式 2：使用命令行（推荐有经验者）

```powershell
# 全局安装 Vue CLI
npm install -g @vue/cli

# 创建 uni-app 项目（Vue 3 版本）
npx degit dcloudio/uni-preset-vue#vite miniprogram-xisixiang

# 进入项目目录
cd miniprogram-xisixiang

# 安装依赖
npm install

# 运行到微信小程序
npm run dev:mp-weixin
```

---

## 第二步：配置项目结构

### 1. 创建页面目录结构

```powershell
cd miniprogram-xisixiang

# 创建页面目录
mkdir -p pages/chat pages/quiz pages/theory pages/knowledge-graph

# 创建 components 目录
mkdir -p components/chat components/quiz
```

### 2. 配置 pages.json（核心路由配置）

创建 `pages.json`：

```json
{
  "pages": [
    {
      "path": "pages/chat/chat",
      "style": {
        "navigationBarTitleText": "智能问答",
        "navigationBarBackgroundColor": "#ff4d4d",
        "navigationBarTextStyle": "white"
      }
    },
    {
      "path": "pages/quiz/quiz",
      "style": {
        "navigationBarTitleText": "习题训练",
        "navigationBarBackgroundColor": "#ff4d4d",
        "navigationBarTextStyle": "white"
      }
    },
    {
      "path": "pages/theory/theory",
      "style": {
        "navigationBarTitleText": "理论学习",
        "navigationBarBackgroundColor": "#ff4d4d",
        "navigationBarTextStyle": "white"
      }
    }
  ],
  "tabBar": {
    "color": "#666666",
    "selectedColor": "#ff4d4d",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "pages/chat/chat",
        "text": "智能问答"
      },
      {
        "pagePath": "pages/quiz/quiz",
        "text": "习题训练"
      },
      {
        "pagePath": "pages/theory/theory",
        "text": "理论学习"
      }
    ]
  },
  "globalStyle": {
    "navigationBarTextStyle": "white",
    "navigationBarTitleText": "习思想课程",
    "navigationBarBackgroundColor": "#ff4d4d",
    "backgroundColor": "#f5f5f5"
  }
}
```

---

## 第三步：迁移关键功能

### 1. 创建 API 请求工具

创建 `utils/request.js`：

```javascript
// utils/request.js
const BASE_URL = "http://localhost:5000"; // 开发环境
// const BASE_URL = 'https://your-domain.com'; // 生产环境

export function request(options) {
  return new Promise((resolve, reject) => {
    uni.showLoading({
      title: "加载中...",
      mask: true,
    });

    uni.request({
      url: BASE_URL + options.url,
      method: options.method || "GET",
      data: options.data || {},
      header: {
        "Content-Type": "application/json",
        ...options.header,
      },
      success: (res) => {
        uni.hideLoading();
        if (res.statusCode === 200) {
          resolve(res.data);
        } else {
          reject(new Error(`请求失败: ${res.statusCode}`));
        }
      },
      fail: (err) => {
        uni.hideLoading();
        uni.showToast({
          title: "网络请求失败",
          icon: "none",
        });
        reject(err);
      },
    });
  });
}

// 智能问答 API
export function chatCompletion(messages) {
  return request({
    url: "/api/chat",
    method: "POST",
    data: { messages },
  });
}

// 获取题目列表
export function getQuestions() {
  return request({
    url: "/api/questions",
    method: "GET",
  });
}

// 获取随机题目
export function getRandomQuiz() {
  return request({
    url: "/api/quiz",
    method: "GET",
  });
}
```

### 2. 创建智能问答页面

创建 `pages/chat/chat.vue`（简化版）：

```vue
<template>
  <view class="chat-page">
    <!-- 聊天窗口 -->
    <scroll-view
      scroll-y
      class="chat-window"
      :scroll-into-view="scrollIntoView"
      scroll-with-animation
    >
      <view
        v-for="(msg, index) in messages"
        :key="index"
        :id="'msg-' + index"
        :class="['message', msg.sender]"
      >
        <text>{{ msg.text }}</text>
      </view>
    </scroll-view>

    <!-- 输入框 -->
    <view class="input-box">
      <input
        v-model="inputText"
        placeholder="请输入问题..."
        confirm-type="send"
        @confirm="sendMessage"
      />
      <button
        @click="sendMessage"
        :disabled="loading || !inputText"
        size="mini"
        type="warn"
      >
        发送
      </button>
    </view>
  </view>
</template>

<script setup>
import { ref } from "vue";
import { chatCompletion } from "@/utils/request";

const messages = ref([
  { sender: "bot", text: "您好！我是智能助手，有什么可以帮您？" },
]);
const inputText = ref("");
const loading = ref(false);
const scrollIntoView = ref("");

const sendMessage = async () => {
  if (!inputText.value.trim() || loading.value) return;

  const text = inputText.value.trim();
  messages.value.push({ sender: "user", text });
  inputText.value = "";
  loading.value = true;

  scrollIntoView.value = "msg-" + (messages.value.length - 1);

  try {
    const res = await chatCompletion(buildPayload());
    messages.value.push({
      sender: "bot",
      text: res.reply || "抱歉，我暂时无法回答。",
    });
  } catch (error) {
    messages.value.push({
      sender: "bot",
      text: "服务暂时不可用，请稍后再试。",
    });
  } finally {
    loading.value = false;
    scrollIntoView.value = "msg-" + (messages.value.length - 1);
  }
};

const buildPayload = () => {
  return messages.value.map((m) => ({
    role: m.sender === "bot" ? "assistant" : "user",
    content: m.text,
  }));
};
</script>

<style scoped>
.chat-page {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.chat-window {
  flex: 1;
  padding: 20rpx;
  background-color: #f5f5f5;
}

.message {
  max-width: 70%;
  padding: 20rpx;
  margin-bottom: 20rpx;
  border-radius: 10rpx;
  word-wrap: break-word;
}

.message.user {
  background: linear-gradient(135deg, #ff7061, #f44336);
  color: white;
  margin-left: auto;
  align-self: flex-end;
}

.message.bot {
  background-color: white;
  color: #333;
}

.input-box {
  display: flex;
  padding: 20rpx;
  background-color: white;
  border-top: 1px solid #eee;
  gap: 20rpx;
}

.input-box input {
  flex: 1;
  padding: 20rpx;
  border: 1px solid #ddd;
  border-radius: 10rpx;
}

.input-box button {
  padding: 20rpx 40rpx;
}
</style>
```

### 3. 创建习题训练页面

创建 `pages/quiz/quiz.vue`（简化版）：

```vue
<template>
  <view class="quiz-page">
    <view v-if="loading" class="loading">
      <text>加载中...</text>
    </view>

    <view v-else-if="questions.length > 0" class="quiz-content">
      <!-- 当前题目 -->
      <view class="question-card">
        <view class="question-header">
          <text>题目 {{ currentIndex + 1 }} / {{ questions.length }}</text>
        </view>

        <view class="question-text">
          {{ currentQuestion.question }}
        </view>

        <view class="options">
          <view
            v-for="(option, idx) in currentQuestion.options"
            :key="idx"
            @click="selectOption(option)"
            :class="[
              'option',
              {
                selected: selectedOption === option,
                correct: submitted && option.startsWith(currentQuestion.answer),
                wrong:
                  submitted &&
                  selectedOption === option &&
                  !option.startsWith(currentQuestion.answer),
              },
            ]"
          >
            <text>{{ option }}</text>
          </view>
        </view>

        <view v-if="submitted" class="explanation">
          <text class="label">解析：</text>
          <text>{{ currentQuestion.explanation }}</text>
        </view>

        <view class="actions">
          <button
            v-if="!submitted"
            @click="submitAnswer"
            :disabled="!selectedOption"
            type="warn"
          >
            提交答案
          </button>
          <button v-else @click="nextQuestion" type="primary">
            {{ currentIndex < questions.length - 1 ? "下一题" : "查看结果" }}
          </button>
        </view>
      </view>
    </view>
  </view>
</template>

<script setup>
import { ref, computed, onMounted } from "vue";
import { getRandomQuiz } from "@/utils/request";

const questions = ref([]);
const currentIndex = ref(0);
const selectedOption = ref("");
const submitted = ref(false);
const loading = ref(true);
const score = ref(0);

const currentQuestion = computed(
  () => questions.value[currentIndex.value] || {}
);

onMounted(async () => {
  try {
    const data = await getRandomQuiz();
    questions.value = data;
  } catch (error) {
    uni.showToast({
      title: "加载失败",
      icon: "none",
    });
  } finally {
    loading.value = false;
  }
});

const selectOption = (option) => {
  if (!submitted.value) {
    selectedOption.value = option;
  }
};

const submitAnswer = () => {
  submitted.value = true;
  if (selectedOption.value.startsWith(currentQuestion.value.answer)) {
    score.value++;
  }
};

const nextQuestion = () => {
  if (currentIndex.value < questions.value.length - 1) {
    currentIndex.value++;
    selectedOption.value = "";
    submitted.value = false;
  } else {
    showResult();
  }
};

const showResult = () => {
  uni.showModal({
    title: "测试完成",
    content: `您的得分：${score.value} / ${questions.value.length}`,
    showCancel: false,
  });
};
</script>

<style scoped>
.quiz-page {
  padding: 20rpx;
}

.question-card {
  background-color: white;
  border-radius: 20rpx;
  padding: 40rpx;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.05);
}

.question-header {
  text-align: center;
  color: #ff4d4d;
  font-weight: bold;
  margin-bottom: 40rpx;
}

.question-text {
  font-size: 32rpx;
  line-height: 1.6;
  margin-bottom: 40rpx;
  color: #333;
}

.options {
  margin-bottom: 40rpx;
}

.option {
  padding: 30rpx;
  margin-bottom: 20rpx;
  border: 2rpx solid #ddd;
  border-radius: 15rpx;
  background-color: #fff;
  transition: all 0.3s;
}

.option.selected {
  border-color: #ff4d4d;
  background-color: #fff5f5;
}

.option.correct {
  border-color: #4caf50;
  background-color: #e8f5e9;
}

.option.wrong {
  border-color: #f44336;
  background-color: #ffebee;
}

.explanation {
  padding: 30rpx;
  background-color: #fff3e0;
  border-radius: 15rpx;
  margin-bottom: 40rpx;
  line-height: 1.6;
}

.label {
  color: #ff6f00;
  font-weight: bold;
  margin-bottom: 10rpx;
}

.actions button {
  width: 100%;
  margin-bottom: 20rpx;
}
</style>
```

---

## 第四步：运行和测试

### 1. 启动后端服务

```powershell
cd server
python app.py
```

### 2. 运行小程序

**使用 HBuilderX**：

```
运行 → 运行到小程序模拟器 → 微信开发者工具
```

**使用命令行**：

```powershell
npm run dev:mp-weixin
```

### 3. 打开微信开发者工具

1. 打开微信开发者工具
2. 导入项目：选择 `dist/dev/mp-weixin` 目录
3. 填写 AppID（可以使用测试号）
4. 开始调试

### 4. 配置开发环境

在微信开发者工具中：

```
详情 → 本地设置
✅ 不校验合法域名
✅ 不校验 TLS 版本
```

---

## 第五步：关键差异说明

### 1. 单位转换

```css
/* Web */
width: 100px;

/* 小程序 */
width: 200rpx; /* 750rpx = 屏幕宽度 */
```

### 2. 导航跳转

```javascript
// Web (Vue Router)
this.$router.push("/chat");

// 小程序 (uni-app)
uni.navigateTo({
  url: "/pages/chat/chat",
});

// Tab 页面使用
uni.switchTab({
  url: "/pages/chat/chat",
});
```

### 3. 提示框

```javascript
// Web
alert("提交成功");

// 小程序
uni.showToast({
  title: "提交成功",
  icon: "success",
});

uni.showModal({
  title: "提示",
  content: "确定要退出吗？",
});
```

### 4. 本地存储

```javascript
// Web
localStorage.setItem("key", "value");

// 小程序
uni.setStorageSync("key", "value");

// 或异步版本
uni.setStorage({
  key: "key",
  data: "value",
});
```

---

## 常见问题

### Q1: 网络请求失败？

**A**: 检查以下几点：

1. 后端服务是否启动
2. 微信开发者工具是否关闭了域名校验
3. URL 是否正确

### Q2: 样式不生效？

**A**:

1. 确保使用 rpx 单位
2. 检查选择器是否正确
3. 小程序不支持某些 CSS 特性

### Q3: 组件无法显示？

**A**:

1. 检查组件路径是否正确
2. 确认组件已正确注册
3. 查看控制台错误信息

---

## 下一步

1. ✅ 完成基础页面迁移
2. ⏭️ 添加 Markdown 渲染（使用 towxml）
3. ⏭️ 优化样式和交互
4. ⏭️ 添加分包加载
5. ⏭️ 配置云函数（可选）
6. ⏭️ 准备上线审核

---

## 参考文档

- [uni-app 官方文档](https://uniapp.dcloud.net.cn/)
- [微信小程序文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [uni-app Vue 3 迁移指南](https://uniapp.dcloud.net.cn/tutorial/vue3-api.html)

---

**创建时间**：2025 年 10 月 17 日  
**预计完成时间**：1-2 周  
**技术支持**：有问题随时问我！ 🚀
